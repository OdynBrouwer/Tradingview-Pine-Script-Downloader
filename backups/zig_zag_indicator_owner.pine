// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Mupsje

//@version=6
indicator("Casa_Real_Live_Pivots_V1", shorttitle = "[CT]RLPS" ,overlay = true, max_lines_count = 500, max_labels_count = 500, max_boxes_count = 500)
import Mupsje/Absolute_ZigZag_Lib_V1/2 as ZigZag

// ---------------------------------------------------------------------------------------------------------------------
// I N P U T S
// ---------------------------------------------------------------------------------------------------------------------

// Input: General options
int iPivotLimit = input.int(
  title   = "Pivot Limit",
  defval  = 1000,
  minval  = 1,
  step    = 1,
  tooltip = "The maximum amount of pivots to be shown.",
  group   = "G E N E R A L")

string iSource = input.string(
  title   = "Source",
  defval  = "high/low",
  options = ["high/low", "custom"],
  group   = "S O U R C E")

float iSourceHigh = input.source(
  title   = "Custom High",
  defval  = close,
  group   = "S O U R C E")

float iSourceLow = input.source(
  title   = "Custom Low",
  defval  = close,
  group   = "S O U R C E")


// Input: Outside Candle Handling
string iOutsideBarPriority = input.string(
  title   = "Priority",
  defval  = "auto",
  options = ["auto", "sentiment", "high", "low"],
  tooltip = "Determines the priority of the zigzag direction when an Outside (Engulfing) bar occurs.\n\nAuto: Uses Lower Timeframe data. Falls back to Sentiment if no data available.\nSentiment: Uses candle color (Green=Low first, Red=High first).\nHigh/Low: Forces specific direction.",
  group   = "O U T S I D E   B A R S")

bool iEnableSecondsCharts = input.bool(
  title   = "Enable Seconds Charts",
  defval  = false,
  tooltip = "Check this if you have a subscription that supports seconds-based charts (e.g., 1s, 5s, 15s). If unchecked, the script will not attempt to use timeframes below 1 minute.",
  group   = "O U T S I D E   B A R S")


// Input: Features
bool iFeatureCloseBreaksClose = input.bool(
  title   = "Close Breaks Close",
  defval  = true,
  tooltip = "Check if current pivot (highest/lowest) close broke previous paired pivot (highest/lowest) close.",
  group   = "F E A T U R E S")

bool iFeatureCloseBreaksPivot = input.bool(
  title   = "Close Breaks Pivot",
  defval  = true,
  tooltip = "Check if current pivot (highest/lowest) close broke previous paired pivot (high/low).",
  group   = "F E A T U R E S")

bool iFeatureIgnoreInsideBars = input.bool(
  title   = "Ignore Inside Bars",
  defval  = false,
  tooltip = "If enabled, Inside Bars will not be used to calculate pivots. Breakouts will be compared to the last non-inside candle.",
  group   = "F E A T U R E S")


// Input: Set theming options
bool iThemeHide = input.bool(
  title   = "Hide",
  defval  = false,
  group   = "T H E M I N G")

bool iThemeShowCloseInfo = input.bool(
  title   = "Show close info",
  defval  = true,
  tooltip = "Show extra close info above and below pivot labels?\nC = Close is higher than previous paired pivot close. \nCP = Close is higher than previous paired pivot.",
  group   = "T H E M I N G")

string iThemeColorMode = input.string(
  title   = "Coloring Strategy",
  defval  = "Trend",
  options = ["Trend", "Trend (Labels Only)", "Mono (Default)"],
  tooltip = "Trend: Colors both lines and labels based on Bullish/Bearish/Neutral trend.\nTrend (Labels Only): Colors labels based on trend, but keeps lines in Default color.\nMono (Default): Uses the Default color for everything.",
  group   = "T H E M I N G")

color iThemeColorDefault = input.color(
  title   = "Default Color",
  defval  = color.rgb(120, 123, 134, 0),
  group   = "T H E M I N G")

color iThemeColorNeutral = input.color(
  title   = "Neutral Color",
  defval  = color.rgb(200, 200, 000, 0),
  group   = "T H E M I N G")

color iThemeColorBullish = input.color(
  title   = "Bullish Color",
  defval  = color.rgb(000, 200, 000, 0),
  group   = "T H E M I N G")

color iThemeColorBearish = input.color(
  title   = "Bearish Color",
  defval  = color.rgb(200, 000, 000, 0),
  group   = "T H E M I N G")

int iThemeLineWidth = input.int(
  title   = "Line width",
  defval  = 2,
  minval  = 1,
  maxval  = 50,
  tooltip = "Width in pixels",
  group   = "T H E M I N G")

string iThemeLabelSize = input.string(
  title   = "Label size",
  defval  = "normal",
  options = ["huge", "large", "normal", "small", "tiny"],
  group   = "T H E M I N G")


// Input: Label Visibility (New Dedicated Group)
// Row 1: Highs
bool iThemeShowLabelH  = input.bool(true, "H",  inline = "labels_h", group = "L A B E L  V I S I B I L I T Y")
bool iThemeShowLabelHH = input.bool(true, "HH", inline = "labels_h", group = "L A B E L  V I S I B I L I T Y")
bool iThemeShowLabelLH = input.bool(true, "LH", inline = "labels_h", group = "L A B E L  V I S I B I L I T Y")
// Row 2: Lows
bool iThemeShowLabelL  = input.bool(true, "L",  inline = "labels_l", group = "L A B E L  V I S I B I L I T Y")
bool iThemeShowLabelLL = input.bool(true, "LL", inline = "labels_l", group = "L A B E L  V I S I B I L I T Y")
bool iThemeShowLabelHL = input.bool(true, "HL", inline = "labels_l", group = "L A B E L  V I S I B I L I T Y")


// Input: Set Tooltip Options
bool iTooltipDisable = input.bool(
  title   = "Disable",
  defval  = false,
  tooltip = "This setting overrides all below tooltip settings.",
  group   = "T O O L T I P S")

bool iTooltipName = input.bool(
  title   = "Show name",
  defval  = true,
  group   = "T O O L T I P S")

bool iTooltipPrice = input.bool(
  title   = "Show price",
  defval  = true,
  group   = "T O O L T I P S")

bool iTooltipClose = input.bool(
  title   = "Show close",
  defval  = true,
  group   = "T O O L T I P S")

bool iTooltipVolume = input.bool(
  title   = "Show volume",
  defval  = true,
  group   = "T O O L T I P S")

bool iTooltipCloseBreaksClose = input.bool(
  title   = "Show close breaks close",
  defval  = true,
  group   = "T O O L T I P S")

bool iTooltipCloseBreaksPivot = input.bool(
  title   = "Show close breaks pivot",
  defval  = true,
  group   = "T O O L T I P S")

bool iTooltipTrend = input.bool(
  title   = "Show trend direction",
  defval  = true,
  group   = "T O O L T I P S")


// Input: Historical Swing options
int iHistSwingLookback = input.int(
  title   = "Historical Swing Lookback (pivots)",
  defval  = 50,
  minval  = 1,
  group   = "H I S T O R Y")

bool iShowHistoricalSwing = input.bool(
  title   = "Show Historical Swing H/L",
  defval  = true,
  group   = "H I S T O R Y")


// Input: Current Price Line
bool iCurrentLineVisible = input.bool(
  title   = "Show Current Price Line",
  defval  = true,
  group   = "C U R R E N T   P R I C E")

color iCurrentLineColor = input.color(
  title   = "Line Color",
  defval  = color.gray,
  group   = "C U R R E N T   P R I C E")

int iCurrentLineWidth = input.int(
  title   = "Line Width",
  defval  = 1,
  minval  = 1,
  maxval  = 4,
  group   = "C U R R E N T   P R I C E")

string iCurrentLineStyle = input.string(
  title   = "Line Style",
  defval  = "Dashed",
  options = ["Solid", "Dashed", "Dotted"],
  group   = "C U R R E N T   P R I C E")


// Input: Live Pivot Projection
bool iLiveProjectionVisible = input.bool(
  title   = "Show Live Projection",
  defval  = true,
  group   = "L I V E   P R O J E C T I O N")

int iLiveProjectionOffset = input.int(
  title   = "Offset (bars)",
  defval  = 3,
  minval  = 1,
  maxval  = 20,
  group   = "L I V E   P R O J E C T I O N")

string iLiveProjectionSize = input.string(
  title   = "Size",
  defval  = size.normal,
  options = [size.tiny, size.small, size.normal, size.large, size.huge],
  group   = "L I V E   P R O J E C T I O N")


// Input: Live Pivot Table
bool iTableVisible = input.bool(
  title   = "Show Live Pivot Table",
  defval  = false,
  group   = "L I V E   T A B L E")

string iTablePosition = input.string(
  title   = "Position",
  defval  = position.bottom_right,
  options = [position.top_left, position.top_center, position.top_right, position.middle_left, position.middle_center, position.middle_right, position.bottom_left, position.bottom_center, position.bottom_right],
  group   = "L I V E   T A B L E")

string iTableSize = input.string(
  title   = "Size",
  defval  = size.small,
  options = [size.auto, size.tiny, size.small, size.normal, size.large, size.huge],
  group   = "L I V E   T A B L E")

int iTableRows = input.int(
  title   = "Rows",
  defval  = 5,
  minval  = 1,
  maxval  = 10,
  group   = "L I V E   T A B L E")

color iTableHeaderBg = input.color(
  title   = "Header Background",
  defval  = color.rgb(30, 30, 60),
  group   = "L I V E   T A B L E")

color iTableBg = input.color(
  title   = "Table Background",
  defval  = color.rgb(20, 20, 40, 80),
  group   = "L I V E   T A B L E")


// Input: Debug/Pattern Info
bool iShowSequence = input.bool(
  title   = "Show Pivot Sequence",
  defval  = false,
  group   = "D E B U G")

bool iDebugLog = input.bool(
  title   = "Enable Debug Logging",
  defval  = false,
  group   = "D E B U G")

string iPatternToMatch = input.string(
  title   = "Pattern to Match (e.g. HH,HL)",
  defval  = "",
  group   = "D E B U G")


// ---------------------------------------------------------------------------------------------------------------------
// C A L C U L A T I O N S
// ---------------------------------------------------------------------------------------------------------------------

// 1. Get Lower Timeframe Data
string ltf = ZigZag.getLowerTimeframePeriod()
string safeLtf = (timeframe.isminutes and timeframe.multiplier <= 1 and not iEnableSecondsCharts) ? timeframe.period : ltf
[ltf_high, ltf_low] = request.security_lower_tf(syminfo.tickerid, safeLtf, [iSourceHigh, iSourceLow])

// 2. Determine Priority Directions
bool ltfAvailable = safeLtf != timeframe.period and not na(ltf_high) and not na(ltf_low)
string ltfDirection = ltfAvailable ? (ltf_high.lastindexof(ltf_high.max()) <= ltf_low.lastindexof(ltf_low.min()) ? "high" : "low") : "high"
string sentimentDirection = close >= open ? "low" : "high"

// 3. Resolve Final Priority
string resolvedPriority = "high" // Default

if iOutsideBarPriority == "high"
    resolvedPriority := "high"
else if iOutsideBarPriority == "low"
    resolvedPriority := "low"
else if iOutsideBarPriority == "sentiment"
    resolvedPriority := sentimentDirection
else if iOutsideBarPriority == "auto"
    if ltfAvailable
        resolvedPriority := ltfDirection
    else
        resolvedPriority := sentimentDirection


// ---------------------------------------------------------------------------------------------------------------------
// L I B R A R Y   S E T U P
// ---------------------------------------------------------------------------------------------------------------------

// Determine Color Logic based on "Coloring Strategy"
bool useTrendColors = iThemeColorMode != "Mono (Default)"
bool colorLines     = iThemeColorMode == "Trend"

// Setup the source for the ZigZag indicator
ZigZag.Source sourceSettings = ZigZag.Source.new(
  high      = iSource == "high/low" ? high : iSourceHigh, 
  low       = iSource == "high/low" ? low : iSourceLow,
  priority  = resolvedPriority)

// Setup to be used features for the ZigZag indicator
ZigZag.Features featuresSettings = ZigZag.Features.new(
  closeBreaksClose = iFeatureCloseBreaksClose, 
  closeBreaksPivot = iFeatureCloseBreaksPivot,
  ignoreInsideBars = iFeatureIgnoreInsideBars)

// Setup the theme for the ZigZag indicator
ZigZag.Theme themeSettings = ZigZag.Theme.new(
  enabled       = not iThemeHide,
  colorDefault  = iThemeColorDefault, 
  colorNeutral  = useTrendColors ? iThemeColorNeutral : iThemeColorDefault, 
  colorBullish  = useTrendColors ? iThemeColorBullish : iThemeColorDefault, 
  colorBearish  = useTrendColors ? iThemeColorBearish : iThemeColorDefault, 
  coloredLines  = colorLines,
  labelSize     = iThemeLabelSize,
  lineWidth     = iThemeLineWidth,
  showLabelL    = iThemeShowLabelL,   
  showLabelLL   = iThemeShowLabelLL,  
  showLabelHL   = iThemeShowLabelHL,  
  showLabelH    = iThemeShowLabelH,   
  showLabelLH   = iThemeShowLabelLH,  
  showLabelHH   = iThemeShowLabelHH,  
  showCloseInfo = iThemeShowCloseInfo,
  showTooltips  = not iTooltipDisable,
  tooltips      = ZigZag.Tooltips.new(iTooltipName, iTooltipPrice, iTooltipClose, iTooltipVolume, iTooltipCloseBreaksClose, iTooltipCloseBreaksPivot))

// All settings for the ZigZag indicator
settings = ZigZag.Settings.new(sourceSettings, featuresSettings, themeSettings, iPivotLimit)

// Create the ZigZag indicator
array<ZigZag.Pivot> pivots = ZigZag.new(settings)


// ---------------------------------------------------------------------------------------------------------------------
// A L E R T  -  S E C T I O N 
// ---------------------------------------------------------------------------------------------------------------------
ZigZag.Pivot latestPivot = not na(pivots) ? pivots.getLast() : na
bool isHH = false
bool isLH = false
bool isHL = false
bool isLL = false
bool isCBC = false
bool isCBP = false

if not na(latestPivot) and pivots.barIsPivot()
    isHH := latestPivot.isHigherHigh()
    isLH := latestPivot.isLowerHigh()
    isHL := latestPivot.isHigherLow()
    isLL := latestPivot.isLowerLow()
    // Close-break flags (respect feature toggles)
    isCBC := iFeatureCloseBreaksClose and latestPivot.closeBreaksClose
    isCBP := iFeatureCloseBreaksPivot and latestPivot.closeBreaksPivot


alertcondition(isHH, title = "Higher High", message = "Higher High detected!")
alertcondition(isLH, title = "Lower High", message = "Lower High detected!")
alertcondition(isHL, title = "Higher Low", message = "Higher Low detected!")
alertcondition(isLL, title = "Lower Low", message = "Lower Low detected!")
alertcondition(isCBC, title = "Close Breaks Close (CBC)", message = "Pivot close broke previous pivot close (CBC).")
alertcondition(isCBP, title = "Close Breaks Pivot (CBP)", message = "Pivot close broke previous pivot extreme (CBP).")
// ---------------------------------------------------------------------------------------------------------------------

ZigZag.CurrentLineSettings currentLineSettings = ZigZag.CurrentLineSettings.new(
    visible = iCurrentLineVisible,
    clr     = iCurrentLineColor,
    width   = iCurrentLineWidth,
    style   = iCurrentLineStyle)

ZigZag.LivePivotSettings livePivotSettings = ZigZag.LivePivotSettings.new(
    visible   = iLiveProjectionVisible,
    offset    = iLiveProjectionOffset,
    size      = iLiveProjectionSize)

ZigZag.LiveTableSettings liveTableSettings = ZigZag.LiveTableSettings.new(
    visible  = iTableVisible,
    position = iTablePosition,
    size     = iTableSize,
    rows     = iTableRows,
    headerBg = iTableHeaderBg,
    tableBg  = iTableBg)


// ---------------------------------------------------------------------------------------------------------------------
// D R A W   V I S U A L I Z A T I O N S
// ---------------------------------------------------------------------------------------------------------------------

// Current Price Line - using export method
var line currentLine = na
currentLine := pivots.drawCurrentPriceLine(currentLineSettings, currentLine)

// Live Pivot Prediction - using export method
var ZigZag.LivePivot livePivot = ZigZag.LivePivot.new()
livePivot := pivots.predictLivePivot(livePivot, high, low, themeSettings, resolvedPriority)
livePivot := pivots.drawLivePivotLabel(livePivot, livePivotSettings)

// Live Pivot Table - using export method
var table pivotTable = na
pivotTable := pivots.drawLivePivotTable(livePivot, liveTableSettings, themeSettings, pivotTable)


// ---------------------------------------------------------------------------------------------------------------------
// S W I N G   H I G H / L O W   V I S U A L S
// ---------------------------------------------------------------------------------------------------------------------

// Temporary variables for tuple assignment (Pine v6 compliant)
var label tempHighLbl = na
var line  tempHighLn  = na
var label tempLowLbl  = na
var line  tempLowLn   = na

var label swingHighLbl = na
var line  swingHighLn  = na
var label swingLowLbl  = na
var line  swingLowLn   = na




// ---------------------------------------------------------------------------------------------------------------------
// D E B U G   F E A T U R E S
// ---------------------------------------------------------------------------------------------------------------------

// Pivot Sequence Display
var label sequenceLabel = na
if barstate.islast and iShowSequence and pivots.size() >= 3
    string sequence = pivots.getSequence(5, livePivot)
    if na(sequenceLabel)
        sequenceLabel := label.new(bar_index, high, "Sequence: " + sequence, style = label.style_label_down, color = color.new(color.blue, 80), textcolor = color.white, size = size.small)
    else
        sequenceLabel.set_xy(bar_index, high)
        sequenceLabel.set_text("Sequence: " + sequence)

// Pattern Matching
var label patternLabel = na
if barstate.islast and iPatternToMatch != "" and pivots.matchesPattern(iPatternToMatch, livePivot)
    ZigZag.Pivot lastPivot = pivots.getLast()
    if not na(lastPivot)
        if na(patternLabel)
            patternLabel := label.new(bar_index - 3, lastPivot.isHigh ? low : high, "Pattern: " + iPatternToMatch, style = lastPivot.isHigh ? label.style_label_up : label.style_label_down, color = color.new(color.green, 70), textcolor = color.white, size = size.normal)
        else
            patternLabel.set_xy(bar_index - 3, lastPivot.isHigh ? low : high)

// Debug Logging
if barstate.islast and iDebugLog and pivots.size() > 0
    ZigZag.Pivot lastPivot = pivots.getLast()
    ZigZag.Pivot dbgLastHigh = pivots.getLastHigh()
    ZigZag.Pivot dbgLastLow = pivots.getLastLow()
    
    log.info("═══════════════════════════════════════")
    log.info("MARKET STRUCTURE DEBUG")
    log.info("───────────────────────────────────────")
    

    if not na(dbgLastHigh)
        log.info("  Last SwingHigh: {0}", str.tostring(dbgLastHigh.point.y, format.mintick))
    if not na(dbgLastLow)
        log.info("  Last SwingLow: {0}", str.tostring(dbgLastLow.point.y, format.mintick))
    log.info("───────────────────────────────────────")
    
    // Show last 5 pivots with their flags
    for i = 0 to math.min(4, pivots.size() - 1)
        ZigZag.Pivot p = pivots.getPrev(i)
        if not na(p)
            string flags = ""
            flags += p.closeBreaksPivot ? "CBP " : ""
            flags += p.closeBreaksClose ? "CBC " : ""
            flags := flags == "" ? "none" : flags

    log.info("───────────────────────────────────────")
    log.info("PREDICTION: {0} @ {1}", livePivot.abbr, str.tostring(livePivot.price, format.mintick))
    if livePivot.isOutsideBar
        log.info("OUTSIDE BAR: {0} → {1}", livePivot.abbr, livePivot.abbr2)
    log.info("═══════════════════════════════════════")
